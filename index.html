<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <title>Ligue de Football à 6</title>
    <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f7f6;
        color: #333;
        min-height: 100vh;
    }
    .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
    }
    header {
        background-color: #3d195b;
        color: white;
        padding: 15px 10px;
        text-align: center;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    h1, h2, h3 {
        margin: 0;
        padding: 0;
    }
    .section {
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 15px;
        margin-bottom: 20px;
        width: 100%;
        box-sizing: border-box;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        table-layout: auto;
    }
    th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        word-break: break-word;
    }
    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    tr:hover {
        background-color: #f5f5f5;
    }
    .team-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
        width: 100%;
    }
    .team-card {
        background-color: white;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        padding: 15px;
        flex: 1 1 calc(50% - 20px);
        min-width: 0;
        box-sizing: border-box;
    }
    .team-card h3 {
        color: #3d195b;
        border-bottom: 2px solid #3d195b;
        padding-bottom: 5px;
        margin-bottom: 10px;
        font-size: 1.2rem;
    }
    .player {
        padding: 5px 0;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
    }
    .player:last-child {
        border-bottom: none;
    }
    .goalkeeper {
        font-weight: bold;
    }
    .tabs {
        display: flex;
        margin-bottom: 15px;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 5px;
    }
    .tab {
        padding: 8px 15px;
        background-color: #e0e0e0;
        border: none;
        cursor: pointer;
        margin-right: 5px;
        border-radius: 5px 5px 5px 5px;
        font-size: 0.9rem;
        flex-shrink: 0;
    }
    .tab.active {
        background-color: #3d195b;
        color: white;
    }
    .tab-content {
        display: none;
        width: 100%;
    }
    .tab-content.active {
        display: block;
    }
    .loading {
        text-align: center;
        padding: 30px;
        font-size: 16px;
        color: #777;
    }
    /* Enhanced Bracket Styles */
    .bracket-section {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 20px;
        -webkit-overflow-scrolling: touch;
    }
    
    .bracket-container {
        display: flex;
        justify-content: flex-start;
        gap: 10px;
        min-width: fit-content;
        align-items: flex-start;
        padding: 15px 10px;
    }
    
    .bracket-round {
        display: flex;
        flex-direction: column;
        justify-content: flex-around;
        min-width: 160px;
    }
    
    .bracket-round-title {
        text-align: center;
        font-weight: bold;
        color: #3d195b;
        margin-bottom: 15px;
        padding: 8px 5px;
        background-color: #f8f5ff;
        border-radius: 4px;
        font-size: 0.9rem;
        position: sticky;
        left: 0;
    }
    
    .bracket-match {
        background-color: white;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 10px;
        margin-bottom: 20px;
        position: relative;
        transition: all 0.3s ease;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .bracket-match:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .bracket-match.winner {
        background-color: rgba(61, 25, 91, 0.1);
        border: 1px solid #3d195b;
    }
    
    .bracket-team {
        display: flex;
        align-items: center;
        padding: 6px 8px;
        margin: 3px 0;
        border-radius: 4px;
        position: relative;
        min-height: 28px;
    }
    
    .bracket-team.winner {
        font-weight: bold;
        color: #3d195b;
    }
    
    .bracket-team.winner::before {
        content: "✓";
        margin-right: 5px;
        color: #4caf50;
    }
    .penalty-score {
        font-size: 0.8em;
        color: #888;
        margin-left: 5px;
    }
    .match-date {
        font-size: 0.7em;
        color: #666;
        text-align: center;
        margin-top: 5px;
        font-style: italic;
    }
    /* Connector lines between rounds */
    .bracket-team::before {
        content: "";
        position: absolute;
        left: -10px;
        top: 50%;
        width: 10px;
        height: 2px;
        background: #aaa;
        display: none;
    }
    
    .bracket-team::after {
        content: "";
        position: absolute;
        left: -10px;
        width: 2px;
        background: #aaa;
        display: none;
    }
    
    .bracket-team.top::after {
        top: 50%;
        bottom: -20px;
    }
    
    .bracket-team.bottom::after {
        top: -20px;
        bottom: 50%;
    }
    
    .bracket-round:not(:first-child) .bracket-team::before,
    .bracket-round:not(:first-child) .bracket-team::after {
        display: block;
    }
    
    .bracket-score {
        margin-left: auto;
        padding-left: 8px;
        font-weight: bold;
        color: #666;
    }
    
    .bracket-team.winner .bracket-score {
        color: #e90052;
    }
    
    /* Special styling for different rounds */
    .bracket-round-32 .bracket-round-title {
        background-color: #e8f5e9;
    }
    
    .bracket-round-16 .bracket-round-title {
        background-color: #e3f2fd;
    }
    
    .bracket-round-8 .bracket-round-title {
        background-color: #fff8e1;
    }
    
    .bracket-round-4 .bracket-round-title {
        background-color: #fce4ec;
    }
    
    .bracket-round-2 .bracket-round-title {
        background-color: #f3e5f5;
        font-size: 1rem;
    }
    
    .bracket-final {
        background-color: #f5f5f5;
    }
    
    .bracket-final .bracket-match {
        background-color: #3d195b;
        color: white;
    }
    
    .bracket-final .bracket-team {
        color: white;
    }
    
    .bracket-final .bracket-team.winner {
        color: #ffeb3b;
    }
    
    .bracket-final .bracket-score {
        color: #ccc;
    }
    
    
    /* Styles pour le terrain de football */
    .field-container {
        margin-top: 15px;
        display: flex;
        flex-direction: column;
        width: 100%;
    }
    .soccer-field {
        position: relative;
        width: 100%;
        height: 220px;
        background-color: #75c043;
        border: 2px solid white;
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 15px;
    }
    .field-line {
        position: absolute;
        background-color: white;
    }
    .center-circle {
        position: absolute;
        width: 60px;
        height: 60px;
        border: 2px solid white;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .center-spot {
        position: absolute;
        width: 6px;
        height: 6px;
        background-color: white;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .goal-box-left, .goal-box-right {
        position: absolute;
        width: 30px;
        height: 60px;
        border: 2px solid white;
        top: 50%;
        transform: translateY(-50%);
    }
    .goal-box-left {
        border-left: none;
        left: 0;
    }
    .goal-box-right {
        border-right: none;
        right: 0;
    }
    .penalty-box-left, .penalty-box-right {
        position: absolute;
        width: 60px;
        height: 120px;
        border: 2px solid white;
        top: 50%;
        transform: translateY(-50%);
    }
    .penalty-box-left {
        border-left: none;
        left: 0;
    }
    .penalty-box-right {
        border-right: none;
        right: 0;
    }
    .goal-left, .goal-right {
        position: absolute;
        width: 6px;
        height: 30px;
        background-color: white;
        top: 50%;
        transform: translateY(-50%);
    }
    .goal-left {
        left: -3px;
    }
    .goal-right {
        right: -3px;
    }
    .halfway-line {
        position: absolute;
        width: 2px;
        height: 100%;
        background-color: white;
        left: 50%;
        transform: translateX(-50%);
    }
    .player-dot {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: black;
        font-weight: bold;
        font-size: 12px;
        transform: translate(-50%, -50%);
        z-index: 5;
    }
    .player-name {
        position: absolute;
        font-size: 14px;
        font-weight: bold;
        transform: translate(-50%, 5px);
        width: 70px;
        text-align: center;
        white-space: wrap;
        overflow: visible;
        text-overflow: ellipsis;
    }
    .position-GK {
        background-color: #4caf50;
    }
    .position-DF, .position-FW {
        background-color: #ffeb3b;
    }
    .player-list {
        margin-top: 10px;
    }
    .formation-title {
        margin-top: 10px;
        font-weight: bold;
        color: #3d195b;
    }
    .team-content {
        display: flex;
        flex-direction: column;
        width: 100%;
    }
    .field-view, .list-view {
        margin-top: 10px;
        width: 100%;
    }
    .view-toggle {
        display: flex;
        margin-top: 10px;
    }
    .view-btn {
        padding: 5px 10px;
        background-color: #e0e0e0;
        border: none;
        cursor: pointer;
        margin-right: 5px;
        border-radius: 3px;
        font-size: 0.8rem;
    }
    .view-btn.active {
        background-color: #3d195b;
        color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
        .team-card {
            flex: 1 1 100%;
        }
        .soccer-field {
            height: 200px;
        }
    }

    @media (max-width: 768px) {
        .container {
            padding: 15px;
        }
        header {
            padding: 12px 8px;
        }
        h1 {
            font-size: 1.5rem;
        }
        h2 {
            font-size: 1.3rem;
        }
        .section {
            padding: 12px;
        }
        th, td {
            padding: 8px 6px;
            font-size: 0.85rem;
        }
        .team-card {
            flex: 1 1 100%;
        }
        .soccer-field {
            height: 180px;
        }
        .player-name {
            font-size: 10px;
            width: 60px;
        }
    }

    @media (max-width: 480px) {
        .container {
            padding: 10px;
        }
        header {
            padding: 10px 5px;
        }
        h1 {
            font-size: 1.3rem;
        }
        h2 {
            font-size: 1.1rem;
        }
        .tab {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        .section {
            padding: 10px;
        }
        th, td {
            padding: 6px 4px;
            font-size: 0.8rem;
        }
        .soccer-field {
            height: 150px;
        }
        .center-circle {
            width: 50px;
            height: 50px;
        }
        .penalty-box-left, .penalty-box-right {
            width: 50px;
            height: 100px;
        }
        .player-name {
            font-size: 9px;
            width: 50px;
        }
        .player-points {
        float: right;
        font-weight: bold;
        color: #3d195b;
    }
    
    .player {
        padding: 8px 0;
        font-size: 0.8rem;
        border-bottom: 1px solid #eee;
        overflow: hidden; /* Pour contenir le float */
    }
    }
</style>

</head>

<body>

    <div class="container">
        <header>
            <h1>Paris entre amis</h1>
            <p>WC 2026</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="openTab('teams')">Équipes</button>
            <button class="tab" onclick="openTab('standings')">Classement</button>
            <button class="tab" onclick="openTab('stats')">Statistiques</button>
            <button class="tab" onclick="openTab('bracket')">Bracket</button>
        </div>

        <!-- Section Équipes -->    
        <div id="teams" class="tab-content active">
            <div class="section">
                <h2>Composition des Équipes</h2>
                <div class="team-container" id="team-container">
                    <div class="loading">Chargement des données...</div>
                </div>
            </div>
        </div>

        <!-- Section Classement -->
        <div id="standings" class="tab-content">
            <div class="section">
                <h2>Classement</h2>
                <table id="standings-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Équipe</th>
                            <th>M1</th>
                            <th>M2</th>
                            <th>M3</th>
                            <th>1/16</th>
                            <th>1/8</th>
                            <th>1/4</th>
                            <th>1/2</th>
                            <th>Final</th>
                            <th>Pts</th>
                        </tr>
                    </thead>
                    <tbody id="standings-body">
                        <tr>
                            <td colspan="11" class="loading">Chargement des données...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Section Bracket -->
        <div id="bracket" class="tab-content">
            <div class="section">
                <h2 id="bracket-title">Tournament Bracket</h2>
                <div class="bracket-section">
                    <div class="bracket-container" id="bracket-container">
                        <div class="loading">Chargement des données...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Statistiques -->
        <div id="stats" class="tab-content">
            <div class="section">
                <h2>Statistiques des Joueurs</h2>
                <table id="player-stats-table">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Nation</th>
                            <th>Position</th>
                            <th>M1</th>
                            <th>M2</th>
                            <th>M3</th>
                            <th>1/16</th>
                            <th>1/8</th>
                            <th>1/4</th>
                            <th>1/2</th>
                            <th>Final</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="player-stats-body">
                        <tr>
                            <td colspan="12" class="loading">Chargement des données...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

     <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC3zpS_NT8sHN4j0upcAd8jmpfhsgXtdRw",
            authDomain: "paris-entre-amis-598e9.firebaseapp.com",
            projectId: "paris-entre-amis-598e9",
            storageBucket: "paris-entre-amis-598e9.firebasestorage.app",
            messagingSenderId: "638642602040",
            appId: "1:638642602040:web:0f7557f7d4923b6aec26cd"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
        });

        // Function to handle tabs
        function openTab(tabName) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }
            const tabs = document.getElementsByClassName("tab");
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove("active");
            }         
            document.getElementById(tabName).classList.add("active");
            event.currentTarget.classList.add("active");
        }

        // Function to toggle between field/list views for each team
        function toggleView(teamId, viewType) {
            const fieldView = document.getElementById(`field-view-${teamId}`);
            const listView = document.getElementById(`list-view-${teamId}`);
            const fieldBtn = document.getElementById(`field-btn-${teamId}`);
            const listBtn = document.getElementById(`list-btn-${teamId}`);
            if (viewType === 'field') {
                fieldView.style.display = 'block';
                listView.style.display = 'none';
                fieldBtn.classList.add('active');
                listBtn.classList.remove('active');
            } else {
                fieldView.style.display = 'none';
                listView.style.display = 'block';
                fieldBtn.classList.remove('active');
                listBtn.classList.add('active');
            }
        }

        // Main function to load all data from Firestore
        async function loadAllData() {
            try {
                // Load teams data
                const teamsSnapshot = await db.collection("teams").get();
                const teams = teamsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        name: data.name,
                        shortName: data.shortName || data.name.substring(0, 3).toUpperCase(),
                        formation: data.formation || "1-2-3",
                        players: data.players || [],
                        results: data.results || {}
                    };
                });

                // Load bracket data
                const bracketDoc = await db.collection("tournament").doc("bracket").get();
                const bracketData = bracketDoc.exists ? bracketDoc.data() : {};

                // Load player stats
                const playersSnapshot = await db.collection("players").get();
                const playerStats = playersSnapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        name: data.name,
                        nation: data.nation, 
                        equipe: data.team,
                        position: data.position || 'FW',
                        matches: data.matches || {}
                    };
                });

                // Render all data
                renderTeams(teams, playerStats);
                renderStandings(teams);
                renderPlayerStats(playerStats);
                renderBracket({
                    teams: teams,
                    bracket: bracketData
                });

            } catch (error) {
                console.error("Error loading data:", error);
                // Show error messages in each section
                document.getElementById('team-container').innerHTML = 
                    `<p class="error">Error loading team data: ${error.message}</p>`;
                document.getElementById('standings-body').innerHTML = 
                    `<tr><td colspan="11" class="error">Error loading standings: ${error.message}</td></tr>`;
                document.getElementById('player-stats-body').innerHTML = 
                    `<tr><td colspan="12" class="error">Error loading player stats: ${error.message}</td></tr>`;
                document.getElementById('bracket-container').innerHTML = 
                    `<p class="error">Error loading bracket: ${error.message}</p>`;
            }
        }

        // Function to render teams with soccer field
       function renderTeams(teams, playerStatsData) {
    const teamContainer = document.getElementById('team-container');
    teamContainer.innerHTML = '';

    // Organiser les joueurs par équipe
    const playersByTeam = {};
    
    // Initialiser le tableau pour chaque équipe
    teams.forEach(team => {
        playersByTeam[team.id] = [];
    });
    
    // Ajouter chaque joueur dans son équipe
    playerStatsData.forEach(player => {
        if (player.equipe && playersByTeam[player.equipe]) {
            playersByTeam[player.equipe].push(player);
        }
    });

    teams.forEach((team, teamIndex) => {
        const teamCard = document.createElement('div');
        teamCard.className = 'team-card';

        // Récupérer tous les joueurs de cette équipe
        const teamPlayers = playersByTeam[team.id] || [];
        
        // Déterminer dynamiquement la formation basée sur les positions des joueurs
        const formation = determineFormation(teamPlayers);
        
        // Trier les joueurs par leur round de draft (croissant)
        const sortedPlayers = [...teamPlayers].sort((a, b) => {
            // D'abord par round (croissant)
            const roundA = a.round || 999;
            const roundB = b.round || 999;
            
            if (roundA !== roundB) {
                return roundA - roundB;
            }
            
            // Ensuite par position (GK, DF, FW)
            const posOrder = { 'GK': 1, 'DF': 2, 'FW': 3 };
            return (posOrder[a.position] || 99) - (posOrder[b.position] || 99);
        });
        
        // Créer la vue liste des joueurs ordonnée par round de draft
        let playersListHtml = '';
        
        sortedPlayers.forEach(player => {
            const isGoalkeeper = player.position === 'GK';
            const positionName = isGoalkeeper ? 'Gardien' : 
                                player.position === 'DF' ? 'Défenseur' : 'Attaquant';
            
            const totalPoints = calculatePlayerTotalPoints(player.matches);
            const draftRound = player.round ? `Round ${player.round}` : '     ';
            
            playersListHtml += `
                <div class="player ${isGoalkeeper ? 'goalkeeper' : ''}">
                    ${player.name} (${positionName}, ${player.nation || ''})
                    <span class="player-details">
                        ${draftRound}
                        <span class="player-points">${totalPoints} pts</span>
                    </span>
                </div>
            `;
        });

        // Créer le HTML de la carte équipe avec les deux vues
        teamCard.innerHTML = `
            <h3>${team.name}</h3>
            <div class="view-toggle">
                <button id="field-btn-${teamIndex}" class="view-btn active" onclick="toggleView(${teamIndex}, 'field')">Vue Terrain</button>
                <button id="list-btn-${teamIndex}" class="view-btn" onclick="toggleView(${teamIndex}, 'list')">Vue Liste</button>
            </div>
            
            <div class="formation-title">Formation: ${formation}</div>
            
            <div class="team-content">
                <div id="field-view-${teamIndex}" class="field-view">
                    <div class="soccer-field">
                        <!-- Field lines -->
                        <div class="halfway-line"></div>
                        <div class="center-circle"></div>
                        <div class="center-spot"></div>
                        <div class="penalty-box-left"></div>
                        <div class="penalty-box-right"></div>
                        <div class="goal-box-left"></div>
                        <div class="goal-box-right"></div>
                        <div class="goal-left"></div>
                        <div class="goal-right"></div>
                    </div>
                </div>
                
                <div id="list-view-${teamIndex}" class="list-view" style="display: none;">
                    <div class="player-list">
                        ${playersListHtml || '<p>Aucun joueur trouvé pour cette équipe</p>'}
                    </div>
                </div>
            </div>
        `;

        teamContainer.appendChild(teamCard);

        // Ajouter les joueurs sur le terrain
        const soccerField = teamCard.querySelector('.soccer-field');
        placePlayersOnField(sortedPlayers, soccerField, formation);
    });
}

         // Fonction pour déterminer la formation en fonction des positions des joueurs
function determineFormation(players) {
    if (!players || players.length === 0) return "1-2-3"; // Formation par défaut

    // Compter le nombre de joueurs par position
    let goalkeepers = 0;
    let defenders = 0;
    let forwards = 0;

    players.forEach(player => {
        if (player.position === 'GK') goalkeepers++;
        else if (player.position === 'DF') defenders++;
        else if (player.position === 'FW') forwards++;
    });

    // S'assurer qu'il y a au moins un gardien
    if (goalkeepers === 0) goalkeepers = 1;

    // Déterminer la formation en fonction de la prédominance des positions
    // Si plus de défenseurs, formation 1-3-2, sinon 1-2-3
    if (defenders >= 3) {
        return "1-3-2";
    } else {
        return "1-2-3";
    }
}

        // Function to place players on the field based on formation
        function placePlayersOnField(players, fieldElement, formation) {
            // Position mapping based on formation
            let positionMapping;
            
            if (formation === "1-2-3") {
                // Formation 1-2-3 (1 GK, 2 DF, 3 FW)
                positionMapping = {
                    'GK': { x: 15, y: 45 },
                    'DF1': { x: 35, y: 25 },
                    'DF2': { x: 35, y: 60 },
                    'FW1': { x: 65, y: 15 },
                    'FW2': { x: 65, y: 45 },
                    'FW3': { x: 65, y: 75 }
                };
            } else {
                // Formation 1-3-2 (1 GK, 3 DF, 2 FW)
                positionMapping = {
                    'GK': { x: 15, y: 45 },
                    'DF1': { x: 35, y: 15 },
                    'DF2': { x: 35, y: 45 },
                    'DF3': { x: 35, y: 75 },
                    'FW1': { x: 65, y: 25 },
                    'FW2': { x: 65, y: 60 }
                };
            }
            
            // Sort players by position (GK, DF, FW)
            const sortedPlayers = [...players].sort((a, b) => {
                const posOrder = { 'GK': 0, 'DF': 1, 'FW': 2 };
                return posOrder[a.position] - posOrder[b.position];
            });
            
            // Count defenders and forwards for placement
            let dfCount = 0;
            let fwCount = 0;
            
            sortedPlayers.forEach(player => {
                const playerDot = document.createElement('div');
                playerDot.className = `player-dot position-${player.position}`;
                
                // Determine field position
                let position;
                
                if (player.position === 'GK') {
                    position = positionMapping['GK'];
                } else if (player.position === 'DF') {
                    dfCount++;
                    const posKey = `DF${dfCount}`;
                    position = positionMapping[posKey] || positionMapping['DF1'];
                } else if (player.position === 'FW') {
                    fwCount++;
                    const posKey = `FW${fwCount}`;
                    position = positionMapping[posKey] || positionMapping['FW1'];
                } else {
                    // Default to center
                    position = { x: 50, y: 50 };
                }
                
                // Position the player
                playerDot.style.left = `${position.x}%`;
                playerDot.style.top = `${position.y}%`;
                               
                // Add player name below
                const playerName = document.createElement('div');
                playerName.className = 'player-name';
                playerName.textContent = player.name;
                playerName.style.left = `${position.x}%`;
                playerName.style.top = `${position.y}%`;
                
                fieldElement.appendChild(playerDot);
                fieldElement.appendChild(playerName);
            });
        }

        // Function to render standings
        function renderStandings(teams) {
    const standingsBody = document.getElementById('standings-body');
    standingsBody.innerHTML = '';

    // Créer un objet pour stocker les totaux des équipes par match
    const teamPointsByMatch = {};
    teams.forEach(team => {
        teamPointsByMatch[team.id] = {
            M1: 0, M2: 0, M3: 0, F32: 0, F16: 0, F8: 0, F4: 0, Final: 0
        };
    });

    // Parcourir tous les joueurs pour calculer les points des équipes
    db.collection("players").get().then(playersSnapshot => {
        const players = playersSnapshot.docs.map(doc => doc.data());
        
        // Pour chaque joueur, ajouter ses points à son équipe
        players.forEach(player => {
            if (player.team && player.matches) {
                const teamId = player.team;
                
                // Si l'équipe existe dans notre liste
                if (teamPointsByMatch[teamId]) {
                    // Pour chaque match, ajouter les points du joueur à ceux de l'équipe
                    for (const [matchKey, points] of Object.entries(player.matches)) {
                        if (teamPointsByMatch[teamId][matchKey] !== undefined) {
                            teamPointsByMatch[teamId][matchKey] += (points || 0);
                        }
                    }
                }
            }
        });

        // Maintenant, nous pouvons trier et afficher les équipes
        const sortedStandings = [...teams].sort((a, b) => {
            const totalA = calculateTeamTotalPointsDynamic(teamPointsByMatch[a.id] || {});
            const totalB = calculateTeamTotalPointsDynamic(teamPointsByMatch[b.id] || {});
            return totalB - totalA;
        });

        sortedStandings.forEach((team, index) => {
            const row = document.createElement('tr');
            const teamPoints = teamPointsByMatch[team.id] || {};
            const totalPoints = calculateTeamTotalPointsDynamic(teamPoints);

            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${team.name}</td>
                <td>${teamPoints.M1 || 0}</td>
                <td>${teamPoints.M2 || 0}</td>
                <td>${teamPoints.M3 || 0}</td>
                <td>${teamPoints.F32 || 0}</td>
                <td>${teamPoints.F16 || 0}</td>
                <td>${teamPoints.F8 || 0}</td>
                <td>${teamPoints.F4 || 0}</td>
                <td>${teamPoints.Final || 0}</td>
                <td><strong>${totalPoints}</strong></td>
            `;
            standingsBody.appendChild(row);
        });
    }).catch(error => {
        console.error("Error loading player data for standings:", error);
        standingsBody.innerHTML = `<tr><td colspan="11" class="error">Error loading data: ${error.message}</td></tr>`;
    });
}

        // Helper function to calculate team total points
        function calculateTeamTotalPoints(results) {
            if (!results) return 0;
            return Object.values(results).reduce((sum, val) => sum + (val || 0), 0);
        }

         function calculateTeamTotalPointsDynamic(matchPoints) {
    if (!matchPoints) return 0;
    return Object.values(matchPoints).reduce((sum, val) => sum + (val || 0), 0);
}

        // Function to render the tournament bracket
        function renderBracket(tournamentData) {
            const container = document.getElementById('bracket-container');
            container.innerHTML = '';
            
            if (!tournamentData.bracket) {
                container.innerHTML = '<p>No bracket data available</p>';
                return;
            }

            // Create rounds in order
            const rounds = [
                { 
                    name: "1/8", 
                    class: "bracket-round-16",
                    matches: tournamentData.bracket.roundOf16 || [] 
                },
                { 
                    name: "1/4", 
                    class: "bracket-round-8",
                    matches: tournamentData.bracket.quarterFinals || [] 
                },
                { 
                    name: "1/2", 
                    class: "bracket-round-4",
                    matches: tournamentData.bracket.semiFinals || [] 
                },
                { 
                    name: "FINAL", 
                    class: "bracket-round-2 bracket-final",
                    matches: tournamentData.bracket.final ? [tournamentData.bracket.final] : [] 
                }
            ];
            
            rounds.forEach(round => {
                if (!round.matches || round.matches.length === 0) return;
                
                const roundDiv = document.createElement('div');
                roundDiv.className = `bracket-round ${round.class}`;
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'bracket-round-title';
                titleDiv.textContent = round.name;
                roundDiv.appendChild(titleDiv);
                
                round.matches.forEach(match => {
                    if (!match) return;
                    
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'bracket-match';
                    
                    const team1 = findTeamById(tournamentData.teams, match.team1Id);
                    const team2 = findTeamById(tournamentData.teams, match.team2Id);
                    
                    const topTeam = document.createElement('div');
                    topTeam.className = `bracket-team top ${match.team1Id === match.winnerId ? 'winner' : ''}`;
                    topTeam.innerHTML = `
                        <span>${team1.shortName}</span>
                        ${match.score1 !== undefined ? 
                            `<span class="bracket-score">${match.score1}</span>` : ''
                        }
                        ${match.penaltyScore1 !== undefined ? 
                            `<span class="penalty-score">(${match.penaltyScore1})</span>` : ''
                        }
                    `;
                    
                    const bottomTeam = document.createElement('div');
                    bottomTeam.className = `bracket-team bottom ${match.team2Id === match.winnerId ? 'winner' : ''}`;
                    bottomTeam.innerHTML = `
                        <span>${team2.shortName}</span>
                        ${match.score2 !== undefined ? 
                            `<span class="bracket-score">${match.score2}</span>` : ''
                        }
                        ${match.penaltyScore2 !== undefined ? 
                            `<span class="penalty-score">(${match.penaltyScore2})</span>` : ''
                        }
                    `;
                    
                    // Add match date if available
                    if (match.date) {
                        const dateDiv = document.createElement('div');
                        dateDiv.className = 'match-date';
                        dateDiv.textContent = match.date;
                        matchDiv.appendChild(dateDiv);
                    }
                                        
                    matchDiv.appendChild(topTeam);
                    matchDiv.appendChild(bottomTeam);            
                    roundDiv.appendChild(matchDiv);
                });
                
                container.appendChild(roundDiv);
            });
        }

        // Helper function to find team by ID
        function findTeamById(teams, id) {
            return teams.find(team => team.id === id) || { 
                name: 'TBD', 
                shortName: 'TBD' 
            };
        }

        // Function to render player statistics
        function renderPlayerStats(playerStats) {
            const playerStatsBody = document.getElementById('player-stats-body');
            playerStatsBody.innerHTML = '';

            // Sort by total points (descending)
            const sortedPlayers = [...playerStats].sort((a, b) => {
                const totalA = calculatePlayerTotalPoints(a.matches);
                const totalB = calculatePlayerTotalPoints(b.matches);
                return totalB - totalA;
            });

            sortedPlayers.forEach(player => {
                const row = document.createElement('tr');
                const totalPoints = calculatePlayerTotalPoints(player.matches);
                
                row.innerHTML = `
                    <td>${player.name}</td>
                    <td>${player.nation}</td>
                    <td>${player.position}</td>
                    <td>${player.matches.M1 || 0}</td>
                    <td>${player.matches.M2 || 0}</td>
                    <td>${player.matches.M3 || 0}</td>
                    <td>${player.matches.F32 || 0}</td>
                    <td>${player.matches.F16 || 0}</td>
                    <td>${player.matches.F8 || 0}</td>
                    <td>${player.matches.F4 || 0}</td>
                    <td>${player.matches.Final || 0}</td>
                    <td><strong>${totalPoints}</strong></td>
                `;
                playerStatsBody.appendChild(row);
            });
        }

        // Helper function to calculate player total points
        function calculatePlayerTotalPoints(matches) {
            if (!matches) return 0;
            return Object.values(matches).reduce((sum, val) => sum + (val || 0), 0);
        }
    </script>
</body>
</html>
